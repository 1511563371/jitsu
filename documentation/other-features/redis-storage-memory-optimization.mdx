# Redis storage memory optimization

Usually more then 50% of incoming traffic is from anonymous users (devices that haven't signed in yet). Jitsu uses Redis as a fast read/write storage.
Since Redis keeps all data in RAM even in slightly loaded projects storage can take up a significant amount of RAM and server memory may run out.

Approximately size of 1 anonymous event in Redis is `1KB`. So if your project has 10 requests per second and let's say 80% of them are anonymous - without user identifiers then:

`8 events * multiplying by 24 hours = 691 200 per day`. It is nearly 700MB of RAM per day.

Jitsu writes anonymous events into Redis using [hash](https://redis.io/topics/data-types) records type. Redis key example:

format:

```
anonymous_events:destination_id#${destinationID}:anonymous_id#${userAnonymousID}
```

example:

```
anonymous_events:destination_id#my_postgres:anonymous_id#bqsyuwusxh
```

There will be stored anonymous events JSON with field = ${eventID} and value will be raw event JSON string:

```
key: anonymous_events:destination_id#my_postgres:anonymous_id#bqsyuwusxh
field: d2a1f74b-f87e-4bd2-92ac-4672e41c03ff
value: "{...}"
```

The most reliable way to handle the RAM problem is having a separate Redis instance for user recognition with finite memory and [keys eviction](https://redis.io/topics/lru-cache) configuration.
You can configure it with the following steps:

1. Configure separate Redis in Jitsu Server configuration file (eventnative.yaml) with anonymous events TTL (default value is 7 days):

```yaml
users_recognition:
  enabled: true
  identification_nodes:
    - /user/internal_id
    - /user/email
  redis:
    host: redis_host
    port: 6379
    password: secret_password
    ttl_minutes: #Optional. Anonymous events TTL in minutes. Default value: 10080 (7 days)
      anonymous_events: 10080 #7 days
```

or with env variable `USER_RECOGNITION_REDIS_URL=redis://:password@host:port`.

TTL (time to live) is applied to Redis keys. It means that events from anonymous users that no longer visit your web pages will be deleted from Redis at the expiration time.
Under the hood Jitsu uses [expire command](https://redis.io/commands/expire) after saving every anonymous event JSON.
Since Redis anonymous events key contains user anonymous ID, Redis will automatically delete key if there was no events from a certain anonymous user 7 days (TTL value).


2. Specify Redis finite memory, eviction policy by adding the following configuration into the `redis.conf` file:

```
maxmemory 25gb
maxmemory-policy allkeys-lru
maxmemory-samples 5
```

Or use command `CONFIG SET` with `redis-cli`:

```
CONFIG SET maxmemory 25gb
CONFIG SET maxmemory-policy allkeys-lru
CONFIG SET maxmemory-samples 5
```

<Hint>
    <code inline="true">CONFIG SET</code> command change current Redis configuration, but doesn't change the config file and after restart Redis will get configuration from file. Make sure that you have added new values to the configuration file after using <code inline="true">CONFIG SET</code> command.
</Hint>

After this configuration, user recognition Redis will automatically rewrite older keys when RAM is almost full.

3. Add Redis compression configuration, so all Redis hash tables with length > 1 (anonymous with more than 1 event inside 1 key) will be converted to the [Redis ziplists](https://redis.com/ebook/part-2-core-concepts/01chapter-9-reducing-memory-use/9-1-short-structures/9-1-1-the-ziplist-representation/)
and compressed. Compression rate is about 8x-10x. It saves about 800-1000% of RAM.

<Hint>
    1. <code inline="true">Compression isn't applied to old data</code>. Compression applies only to Redis hash tables which have been created after this configuration.
    2. <code inline="true">Compression applies only to hash tables with length > 1</code>. It means that size of a hash table with 1 event =~ 1KB, and size with hash table with 2 events =~1.08KB, 3 events =~1.16KB.
</Hint>

Configuration:

```
list-compress-depth 1
hash-max-ziplist-value 2000
```

Or use command `CONFIG SET` with `redis-cli`:

```
CONFIG SET list-compress-depth 1
CONFIG SET hash-max-ziplist-value 2000
```

<Hint>
    <code inline="true">CONFIG SET</code> command change current Redis configuration, but doesn't change the config file and after restart Redis will get configuration from file. Make sure that you have added new values to the configuration file after using <code inline="true">CONFIG SET</code> command.
</Hint>

You can check how much memory any key consumes with `redis-cli` command:

```
DEBUG OBJECT <REDIS KEY>
```

4. If you can't change the redis configuration, you can enable GZIP compression on the Jitsu side. It will approximately reduce Redis memory consumption by 30%.
Just add `users_recognition.compression: 'gzip'` to the Jitsu Server configuration (eventnative.yaml):

```yaml
users_recognition:
  enabled: true
  compression: 'gzip'
  identification_nodes:
    - /user/internal_id
    - /user/email
  redis:
    host: redis_host
    port: 6379
    password: secret_password
    ttl_minutes: #Optional. Anonymous events TTL in minutes. Default value: 10080 (7 days)
      anonymous_events: 10080 #7 days
```

<Hint>
    We do not recommend use both Redis ziplist compression and Jitsu GZIP compression. The effectiveness can be very low.
</Hint>
import {APIParam, APIMethod} from "../../../components/documentationComponents";
import {Hint, LargeLink} from "../../../components/documentationComponents";

# Sources Configuration

## Sources

Sources are used to import data from platforms API (Google Analytics, Facebook, etc) or databases (redis, firebase, etc) into [destinations](/docs/destinations-configuration).
Specific data can be stored into your data warehouse for analytics or other needs. Data synchronization is executed with [sync tasks](/docs/sources-configuration/sync-tasks).

## Collections

As the source may contain inhomogeneous data, it may be split into multiple `collections`. Each collection represents some subset of data that would be stored to the same structure within the destination (in the case of SQL database, this is a table).

Collections may be static or configurable. For instance, **Firebase** collections are static while **Google Analytics** report is parametrized (**Google Analytics** has `dimensions` and `metrics`).

Full description of the collection:

```yaml
collections:
  - name: "some_name"
    type: "collection_type_id"
    table_name: "table_name_for_data"
    start_date: "2020-06-01"
    schedule: '@daily' #cron expression. see below
    parameters:
      field1: "value"
      field2: ["values"]
      field3: 
        some_object:
      ...
```

| Parameter | Description |
| :--- | :--- |
| `name` (required)  | is a unique identifier of collection within a list of collections |
| `type`  | determines which data subset must be synchronized. If type absents, type equals to `name` parameter |
| `table_name` | name of the table to keep synchronized data. If not set, equals to the name of collection |
| `start_date` | start date string of data to download in `YYYY-MM-DD` format. Default values is `365` days ago |
| `schedule`   | [cron expression](https://en.wikipedia.org/wiki/Cron) automatic collection synchronization schedule. If not set - only manual collection synchronization(by HTTP API) will be available |
| `parameters` | if the collection is parametrized, parameter values are set here. A value may be of any type (`string`, `number`, `boolean`, `list`, `object`) |

If the collection has no parameters, it may be configured only by its name as a string argument. For example:

```yaml
collections: ["collection1_id", "collection2_id"]
```

## Configuration

<Hint>
    This feature requires:
    <li><code inline="true">meta.storage</code> <a href="/docs/configuration">configuration</a></li>
    <li><code inline="true">primary_key_fields</code> <a href="/docs/configuration/primary-keys-configuration">configuration</a> (in Postgres destination case)</li>
</Hint>

Example of source configuration:

```yaml
sources:
  firebase_example_id:
    type: firebase
    destinations:
      - "<DESTINATION_ID>"
    collections:
      - "<FIRESTORE_COLLECTION_ID>"
    config:
      project_id: "<FIREBASE_PROJECT_ID>"
      key: '<GOOGLE_SERVICE_ACCOUNT_KEY_JSON>'
  google_analytics_example_id:
    type: google_analytics
    destinations:
      - "<DESTINATION_ID>"
    collections:
      - name: "report_test"
        type: "report"
        schedule: '45 23 * * 6'
        parameters:
          dimensions:
            - "ga:country"
            - "ga:yearMonth"
          metrics:
            - "ga:sessions"
    config:
      view_id: "<VIEW_ID_VALUE>"
      auth:
        service_account_key: "<GOOGLE_SERVICE_ACCOUNT_KEY_JSON>"
  ...

```

Common yaml properties for all sources (**all yaml properties are required**):

| Property | Description |
| :--- | :--- |
| `type`  | determines the type of a data source from which data would be imported (like `google_analytics` or `firebase`) |
| `destinations`  | list of destination ids where result must be stored |
| `collections`  | list of collections to synchronize |
| `config` | custom parameters for each source type |

To see how to configure some type of source, please visit documentation pages for exact source types.

### Configuring sources via HTTP - endpoint

If sources configuration is generated by an external service, it is possible to externalize via HTTP end - point \(or file\) as follows:

```yaml
sources: 'location'
```

The location can be`http(s)://` of a local file \(`/path/to/file`\) location and should contain YAML or \(JSON that is identical to YAML structure\). If the location is an URL, the client will respect `If-Modified-Since` / `Last-Modified` caching.

Example of URL content:

```json
{
  "sources": { #json object where inner keys - sources unique ids
    "facebook_marketing_online_sales": { #source config object
      "type": "facebook_marketing",
      ...
    },
    "facebook_marketing_offline_sales": {
      "type": "facebook_marketing",
      ...
    }
  }
}
```

## How it works

Data may be synchronized by time chunks (if data source supports data loading by time intervals) or all data is loaded together. This depends on the type of data source and defined at driver implementation (an entity that loads data). EventNative stores information about synchronized chunks at `meta.storage` (meta storage configuration is described at [General Configuration](/docs/configuration)). Time chunk is synchronized if

* it is not synchronized yet
* time chunk covers the current moment
* time chunk covers the previous period to the current one (in case some data is loaded after the period ends)

The result of synchronization is a replica of data from the data source with some enriched fields. 

* `collection_id` contains the type of collection (see documentation on collections [below](/docs/sources-configuration#collections))
* `$server.unique_id_field` column name depends on `server.unique_id_field` configuration. (`eventn_ctx_event_id` by default) - a hash of the synchronized object
* `time_interval` field stores information about what synchronization interval
* `interval_start` field stores information about start of synchronization interval
* `interval_end` field stores information about the end of synchronization interval

## All supported sources

### Services

<LargeLink href="/docs/sources-configuration/facebook-marketing" title="Facebook Marketing"/>

<LargeLink href="/docs/sources-configuration/google-analytics" title="Google Analytics"/>

<LargeLink href="/docs/sources-configuration/google-play" title="Google Play"/>

### Databases

<LargeLink href="/docs/sources-configuration/firebase" title="Firebase"/>

<LargeLink href="/docs/sources-configuration/redis" title="Redis"/>

### Singer

<LargeLink href="/docs/sources-configuration/singer-taps" title="Singer"/>